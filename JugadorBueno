package BBDD;

import java.sql.*;
import java.util.Scanner;
import java.util.List;
import java.util.ArrayList;
import java.util.Random;

public class JugadorLaberinto {
    private static Connection conexion;
    private static Scanner scn = new Scanner(System.in);
    private static int vidaJugador = 100;
    private static int posX, posY;
    private static char[][] laberinto;
    private static boolean[][] visitado;
    private static int tamaÃ±o;
    private static String usuario;
    private static int laberintoSeleccionado;
    private static int disposicionSeleccionada;
    private static int dmgCocodrilo = 25;
    private static int vidaBotiquin = 20;
    private static Random random = new Random();

    public static void main(String[] args) {
        conectarBD();
        if (conexion != null) {
            mostrarLaberintosDisponibles();
            jugar();
            cerrarConexion();
        }
    }

    private static void conectarBD() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            conexion = DriverManager.getConnection(
                "jdbc:mysql://localhost/laberintobueno", 
                "root", 
                "mysql"
            );
            System.out.println("ConexiÃ³n con BD establecida");
        } catch (Exception e) {
            System.err.println(" Error al conectar con la BD: " + e.getMessage());
            System.exit(1);
        }
    }

    private static void mostrarLaberintosDisponibles() {
        try (Statement stmt = conexion.createStatement()) {
            ResultSet rs = stmt.executeQuery(
                "SELECT id, dimension1, cocodrilos, botiquines, dmgCocodrilo FROM Laberintos"
            );
            
            System.out.println("\nğŸ° === LABERINTOS DISPONIBLES ===");
            System.out.println("â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            System.out.println("â”‚ ID â”‚ TamaÃ±o  â”‚ Cocodrilos  â”‚ Botiquines  â”‚ DaÃ±o Cocodr. â”‚");
            System.out.println("â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            
            while (rs.next()) {
                System.out.printf(
                    "â”‚ %-2d â”‚ %2dx%-2d   â”‚     %-3d     â”‚     %-3d     â”‚      %-3d     â”‚%n",
                    rs.getInt("id"),
                    rs.getInt("dimension1"),
                    rs.getInt("dimension1"),
                    rs.getInt("cocodrilos"),
                    rs.getInt("botiquines"),
                    rs.getInt("dmgCocodrilo")
                );
            }
            System.out.println("â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        } catch (SQLException e) {
            System.err.println("âŒ Error al obtener laberintos: " + e.getMessage());
        }
    }

    private static void jugar() {
        System.out.print("\nğŸ‘¤ Introduce tu nombre de usuario: ");
        usuario = scn.nextLine().trim();
        
        while (usuario.isEmpty()) {
            System.out.print("âŒ El nombre no puede estar vacÃ­o. Introduce tu nombre: ");
            usuario = scn.nextLine().trim();
        }
        
        System.out.print("ğŸ¯ Selecciona el ID del laberinto: ");
        laberintoSeleccionado = scn.nextInt();
        scn.nextLine();

        if (cargarLaberinto(laberintoSeleccionado)) {
            iniciarJuego();
        } else {
            System.out.println("âŒ No se pudo cargar el laberinto. El programa terminarÃ¡.");
        }
    }

    private static boolean cargarLaberinto(int idLaberinto) {
        try {
            // Obtener configuraciÃ³n del laberinto
        	// Aqui usamos una prepared statement para mas seguridad
            PreparedStatement psLab = conexion.prepareStatement(
                "SELECT dimension1, cocodrilos, botiquines, dmgCocodrilo FROM Laberintos WHERE id = ?"
            );
            psLab.setInt(1, idLaberinto);
            ResultSet rsLab = psLab.executeQuery();
            
            if (!rsLab.next()) {
                System.out.println("âŒ Laberinto no encontrado.");
                return false;
            }
            
            tamaÃ±o = rsLab.getInt("dimension1");
            int numCocodrilos = rsLab.getInt("cocodrilos");
            int numBotiquines = rsLab.getInt("botiquines");
            dmgCocodrilo = rsLab.getInt("dmgCocodrilo");
            
            System.out.printf("ğŸ° Cargando laberinto %dx%d con %d cocodrilos y %d botiquines...%n", tamaÃ±o, tamaÃ±o, numCocodrilos, numBotiquines);
            
            // Iniciamos el  laberinto
            laberinto = new char[tamaÃ±o][tamaÃ±o];
            visitado = new boolean[tamaÃ±o][tamaÃ±o];
            inicializarLaberinto();

            // Obtener disposiciÃ³n
            PreparedStatement psDisposicion = conexion.prepareStatement(
                "SELECT id FROM Disposiciones WHERE id_laberinto = ? LIMIT 1"
            );
            psDisposicion.setInt(1, idLaberinto);
            ResultSet rsDisposicion = psDisposicion.executeQuery();
            
            if (rsDisposicion.next()) {
                disposicionSeleccionada = rsDisposicion.getInt("id");
                cargarPuertas(disposicionSeleccionada);
                colocarElementosAleatorios(numCocodrilos, numBotiquines);
                return true;
            } else {
                System.out.println("âŒ No se encontrÃ³ disposiciÃ³n para este laberinto.");
                return false;
            }

        } catch (SQLException e) {
            System.err.println("âŒ Error al cargar laberinto: " + e.getMessage());
            return false;
        }
    }

    // Metodo para iniciar el laberinto 
    private static void inicializarLaberinto() {
        // Inicializar todo como paredes
        for (int i = 0; i < tamaÃ±o; i++) {
            for (int j = 0; j < tamaÃ±o; j++) {
                laberinto[i][j] = '|'; //  Esto es el simbolo para la pared
                visitado[i][j] = false;
            }
        }
        
        // Establecemos la entrada y la  salida
        laberinto[0][0] = '*'; // Entrada
        laberinto[tamaÃ±o-1][tamaÃ±o-1] = '='; // Salida
        
        // PosiciÃ³n inicial del jugador
        posX = 0;
        posY = 0;
        visitado[posX][posY] = true;
    }

    private static void cargarPuertas(int idDisposicion) throws SQLException {
        PreparedStatement ps = conexion.prepareStatement(
            "SELECT coord1, coord2 FROM Puertas WHERE id_disposicion = ? ORDER BY posicion"
        );
        ps.setInt(1, idDisposicion);
        ResultSet rs = ps.executeQuery();
        
        ArrayList<int[]> caminosLibres = new ArrayList<>();
        
        while (rs.next()) {
            int x = rs.getInt("coord1");
            int y = rs.getInt("coord2");
            
            // Solo marcar como camino si no es entrada ni salida
            if (!(x == 0 && y == 0) && !(x == tamaÃ±o-1 && y == tamaÃ±o-1)) {
                laberinto[x][y] = '-'; // Camino libre
                caminosLibres.add(new int[]{x, y});
            }
        }
        
        System.out.printf("âœ… Cargados %d caminos libres%n", caminosLibres.size());
    }

    private static void colocarElementosAleatorios(int numCocodrilos, int numBotiquines) {
        // Obtener todas las casillas de camino (excluyendo entrada y salida)
        ArrayList<int[]> casillasDisponibles = new ArrayList<>();
        
        for (int i = 0; i < tamaÃ±o; i++) {
            for (int j = 0; j < tamaÃ±o; j++) {
                if (laberinto[i][j] == '-') { // Solo caminos libres
                    casillasDisponibles.add(new int[]{i, j});
                }
            }
        }
        
        // Mezclar las casillas disponibles
        java.util.Collections.shuffle(casillasDisponibles, random);
        
        int elementosColocados = 0;
        
        // Colocar cocodrilos
        for (int i = 0; i < numCocodrilos && i < casillasDisponibles.size(); i++) {
            int[] pos = casillasDisponibles.get(elementosColocados++);
            laberinto[pos[0]][pos[1]] = 'C';
        }
        
        // Colocar botiquines
        for (int i = 0; i < numBotiquines && elementosColocados < casillasDisponibles.size(); i++) {
            int[] pos = casillasDisponibles.get(elementosColocados++);
            laberinto[pos[0]][pos[1]] = 'B';
        }
        
        System.out.printf("ğŸŠ Colocados %d cocodrilos aleatoriamente%n", 
                         Math.min(numCocodrilos, casillasDisponibles.size()));
        System.out.printf("ğŸ¥ Colocados %d botiquines aleatoriamente%n", 
                         Math.min(numBotiquines, casillasDisponibles.size() - numCocodrilos));
    }

    private static void iniciarJuego() {
        System.out.println("\nğŸ® Â¡COMIENZA EL JUEGO!");
        System.out.println("ğŸ¯ Objetivo: Llegar desde la entrada (*) hasta la salida (=)");
        System.out.println("âš ï¸  Cuidado con los cocodrilos (C) y busca los botiquines (B)");
        System.out.println("ğŸ—ºï¸  Solo conoces tu entorno inmediato...");
        
        while (vidaJugador > 0) {
            mostrarEstadoJuego();
            procesarMovimiento();
            verificarCasillaActual();
            
            if (haGanado()) {
                System.out.println("\nğŸ‰ Â¡FELICIDADES! Â¡HAS LLEGADO A LA SALIDA!");
                System.out.printf("ğŸ† Vida restante: %d puntos%n", vidaJugador);
                guardarResultado(true);
                mostrarRanking();
                return;
            }
        }
        
        System.out.println("\nğŸ’€ Â¡HAS PERDIDO TODA TU VIDA!");
        System.out.println("ğŸ”„ Â¡IntÃ©ntalo de nuevo!");
        guardarResultado(false);
    }

    private static void mostrarEstadoJuego() {
        System.out.println("\n" + "â•".repeat(50));
        System.out.println("ğŸ—ºï¸  MAPA EXPLORADO");
        mostrarMapaExplorado();
        System.out.printf("â¤ï¸  Vida actual: %d/100%n", vidaJugador);
        
        // Mostrar movimientos disponibles
        System.out.print("ğŸ§­ Movimientos disponibles: ");
        List<String> movimientosDisponibles = new ArrayList<>();
        
        if (posX > 0 && esMovimientoValido(posX-1, posY)) {
            movimientosDisponibles.add("W (Norte)");
        }
        if (posX < tamaÃ±o-1 && esMovimientoValido(posX+1, posY)) {
            movimientosDisponibles.add("S (Sur)");
        }
        if (posY > 0 && esMovimientoValido(posX, posY-1)) {
            movimientosDisponibles.add("A (Oeste)");
        }
        if (posY < tamaÃ±o-1 && esMovimientoValido(posX, posY+1)) {
            movimientosDisponibles.add("D (Este)");
        }
        
        if (movimientosDisponibles.isEmpty()) {
            System.out.println("Â¡NINGUNO! EstÃ¡s atrapado.");
        } else {
            System.out.println(String.join(", ", movimientosDisponibles));
        }
        
        darPistasUbicacion();
    }
    
    private static void mostrarMapaExplorado() {
        System.out.println("Leyenda: [?] = No explorado, [-] = Camino, [|] = Pared, [*] = Entrada, [=] = Salida");
        System.out.println("         [C] = Cocodrilo, [B] = BotiquÃ­n, [X] = Tu posiciÃ³n actual");
        System.out.println();
        
        // Mostrar coordenadas superiores
        System.out.print("   ");
        for (int j = 0; j < tamaÃ±o; j++) {
            System.out.printf("%2d ", j);
        }
        System.out.println();
        
        for (int i = 0; i < tamaÃ±o; i++) {
            System.out.printf("%2d ", i);
            for (int j = 0; j < tamaÃ±o; j++) {
                if (i == posX && j == posY) {
                    System.out.print(" X ");
                } else if (visitado[i][j]) {
                    char casilla = laberinto[i][j];
                    System.out.printf(" %c ", casilla);
                } else {
                    if (esAdyacente(i, j) && !esMovimientoValido(i, j)) {
                        System.out.print(" | ");
                    } else {
                        System.out.print(" ? ");
                    }
                }
            }
            System.out.println();
        }
        System.out.println();
    }
    
    // Metodo para comprobar si es adyacente 
    private static boolean esAdyacente(int x, int y) {
        return Math.abs(x - posX) + Math.abs(y - posY) == 1;
    }
    
    private static void darPistasUbicacion() {
        if (posX == 0 && posY == 0) {
            System.out.println("ğŸ’¡ EstÃ¡s en el punto de partida del laberinto.");
        } else if (posX == tamaÃ±o-1 && posY == tamaÃ±o-1) {
            System.out.println("ğŸ¯ Â¡Sientes una brisa fresca! La salida estÃ¡ aquÃ­.");
        } else {
            if (posX == 0) {
                System.out.println("ğŸ’¡ Sientes una pared sÃ³lida al norte.");
            } else if (posX == tamaÃ±o-1) {
                System.out.println("ğŸ’¡ Sientes una pared sÃ³lida al sur.");
            }
            
            if (posY == 0) {
                System.out.println("ğŸ’¡ Sientes una pared sÃ³lida al oeste.");
            } else if (posY == tamaÃ±o-1) {
                System.out.println("ğŸ’¡ Sientes una pared sÃ³lida al este.");
            }
            
            int distanciaASalida = Math.abs(posX - (tamaÃ±o-1)) + Math.abs(posY - (tamaÃ±o-1));
            if (distanciaASalida <= 2) {
                System.out.println("ğŸŒŸ Sientes que la salida estÃ¡ muy cerca...");
            } else if (distanciaASalida <= tamaÃ±o/2) {
                System.out.println("ğŸ§­ EstÃ¡s en una zona intermedia del laberinto.");
            } else {
                System.out.println("ğŸ—ºï¸  Sientes que aÃºn queda un largo camino.");
            }
        }
    }

    private static void procesarMovimiento() {
        System.out.print("\nâ¡ï¸  Â¿Hacia dÃ³nde quieres moverte? (W/A/S/D): ");
        String movimiento = scn.nextLine().toUpperCase().trim();
        
        int newX = posX;
        int newY = posY;
        String direccion = "";
        
        switch (movimiento) {
            case "W": 
                newX--; 
                direccion = "norte";
                break;
            case "S": 
                newX++; 
                direccion = "sur";
                break;
            case "A": 
                newY--; 
                direccion = "oeste";
                break;
            case "D": 
                newY++; 
                direccion = "este";
                break;
            default: 
                System.out.println("âŒ Movimiento invÃ¡lido! Usa W, A, S, D"); 
                return;
        }
        
        System.out.printf("ğŸš¶ Te diriges hacia el %s...%n", direccion);
        
        if (esMovimientoValido(newX, newY)) {
            posX = newX;
            posY = newY;
            visitado[posX][posY] = true;
            System.out.println("âœ… Te mueves exitosamente.");
        } else {
            System.out.println("ğŸš§ Â¡Te topas con una pared! No puedes moverte en esa direcciÃ³n.");
        }
    }

    private static boolean esMovimientoValido(int x, int y) {
        if (x < 0 || x >= tamaÃ±o || y < 0 || y >= tamaÃ±o) {
            return false;
        }
        
        char casilla = laberinto[x][y];
        return casilla == '-' || casilla == '*' || casilla == '=' || 
               casilla == 'C' || casilla == 'B';
    }

    private static void verificarCasillaActual() {
        char casilla = laberinto[posX][posY];
        
        if (casilla == 'C') {
            System.out.printf("ğŸŠ Â¡COCODRILO ATACA! Pierdes %d puntos de vida.%n", dmgCocodrilo);
            vidaJugador -= dmgCocodrilo;
            // Cambiar la casilla a camino normal despuÃ©s del encuentro
            laberinto[posX][posY] = '-';
            
            if (vidaJugador <= 0) {
                System.out.println("ğŸ’€ El cocodrilo te ha derrotado...");
                vidaJugador = 0;
            } else {
                System.out.printf("ğŸ’” Vida restante: %d%n", vidaJugador);
            }
        } else if (casilla == 'B') {
            System.out.printf("ğŸ¥ Â¡BOTIQUÃN ENCONTRADO! Recuperas %d puntos de vida.%n", vidaBotiquin);
            vidaJugador += vidaBotiquin;
            // Cambiar la casilla a camino normal despuÃ©s de usar el botiquÃ­n
            laberinto[posX][posY] = '-';
            
            if (vidaJugador > 100) {
                vidaJugador = 100;
                System.out.println("ğŸ’š Tu vida estÃ¡ al mÃ¡ximo (100).");
            } else {
                System.out.printf("ğŸ’š Vida actual: %d%n", vidaJugador);
            }
        }
    }

    private static boolean haGanado() {
        return posX == tamaÃ±o-1 && posY == tamaÃ±o-1;
    }

    private static void guardarResultado(boolean salida) {
        try (PreparedStatement ps = conexion.prepareStatement(
            "INSERT INTO Ranking (usuario, vida, laberinto, disposicion, salida) VALUES (?, ?, ?, ?, ?) " +
            "ON DUPLICATE KEY UPDATE vida = GREATEST(vida, VALUES(vida)), salida = VALUES(salida)")) {
            
            ps.setString(1, usuario);
            ps.setInt(2, vidaJugador);
            ps.setInt(3, laberintoSeleccionado);
            ps.setInt(4, disposicionSeleccionada);
            ps.setBoolean(5, salida);
            ps.executeUpdate();
            
            if (salida) {
                System.out.println("ğŸ† Tu resultado ha sido guardado en el ranking.");
            }
        } catch (SQLException e) {
            System.err.println("âŒ Error al guardar resultado: " + e.getMessage());
        }
    }

    private static void mostrarRanking() {
        try (Statement stmt = conexion.createStatement()) {
            ResultSet rs = stmt.executeQuery(
                "SELECT usuario, vida, salida FROM Ranking WHERE salida = 1 ORDER BY vida DESC LIMIT 10"
            );
            
            System.out.println("\nğŸ† === TOP 10 JUGADORES (VICTORIOSOS) ===");
            System.out.println("â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            System.out.println("â”‚ Pos â”‚     Usuario      â”‚ Vida â”‚  Completado â”‚");
            System.out.println("â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            
            int posicion = 1;
            while (rs.next()) {
                String emoji = posicion == 1 ? "ğŸ¥‡" : posicion == 2 ? "ğŸ¥ˆ" : posicion == 3 ? "ğŸ¥‰" : "ğŸ…";
                System.out.printf(
                    "â”‚%s %-2d â”‚ %-16s â”‚ %-4d â”‚     %-3s     â”‚%n",
                    emoji,
                    posicion,
                    rs.getString("usuario"),
                    rs.getInt("vida"),
                    rs.getBoolean("salida") ? "SÃ­" : "No"
                );
                posicion++;
            }
            System.out.println("â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
            
            if (posicion == 1) {
                System.out.println("ğŸ¯ Â¡SÃ© el primero en completar un laberinto!");
            }
        } catch (SQLException e) {
            System.err.println("âŒ Error al obtener ranking: " + e.getMessage());
        }
    }

    private static void cerrarConexion() {
        try {
            if (conexion != null) {
                conexion.close();
                System.out.println("âœ… ConexiÃ³n cerrada correctamente.");
            }
        } catch (SQLException e) {
            System.err.println("âŒ Error al cerrar conexiÃ³n: " + e.getMessage());
        }
    }
}
